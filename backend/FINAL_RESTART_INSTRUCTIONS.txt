═══════════════════════════════════════════════════════════════
  VoxChina 后端重启指南 - KeyError '"type"' 修复完成
═══════════════════════════════════════════════════════════════

⚠️  所有代码修复已完成，但需要你重启后端才能生效！

当前状态：
  • ✅ _sanitize_json_keys() 方法已添加并在 3 处调用
  • ✅ 日语 tokenizer 已彻底移除
  • ✅ 所有 Python 缓存已清除
  • ❌ 旧进程（PID: 2971207）还在运行旧代码

═══════════════════════════════════════════════════════════════
  🔧 执行重启（只需一条命令）
═══════════════════════════════════════════════════════════════

方法 1：使用自动化脚本（推荐）
------------------------------------------------------------
sudo /www/wwwroot/voxchina/backend/force_restart_now.sh


方法 2：手动执行
------------------------------------------------------------
sudo pkill -9 -f "uvicorn main:app.*8300"
sleep 3
sudo -u www bash -c 'cd /www/wwwroot/voxchina/backend && nohup ./venv/bin/uvicorn main:app --host 0.0.0.0 --port 8300 --workers 1 --log-level info > /tmp/voxchina_backend_new.log 2>&1 &'


═══════════════════════════════════════════════════════════════
  ✅ 验证重启成功
═══════════════════════════════════════════════════════════════

1. 检查进程启动时间（应该是刚才的时间）：
   ps aux | grep "uvicorn main:app.*8300" | grep -v grep

2. 检查健康状态：
   curl http://localhost:8300/health

3. 测试文本提取：
   访问 http://llmhi.com:8400/legacy
   上传文档测试

4. 如果还有问题，查看新日志：
   tail -n 100 /tmp/voxchina_backend_new.log


═══════════════════════════════════════════════════════════════
  📊 修复原理说明
═══════════════════════════════════════════════════════════════

问题根因：
  LLM (GPT-4o) 有时返回错误的 JSON 键名格式：
  - 错误: {'"type"': '核心发现'}
  - 正确: {'type': '核心发现'}

解决方案：
  添加 _sanitize_json_keys() 方法递归清理所有键名：
  - 移除键名外层的引号: '"type"' → 'type'
  - 处理转义字符: '\"type\"' → 'type'
  - 递归处理嵌套对象和数组

应用位置：
  1. _extract_chunk_facts() - 提取 chunk 事实
  2. _merge_fact_table() - 合并事实表
  3. _generate_summary() - 生成摘要


═══════════════════════════════════════════════════════════════
  📝 修复时间线
═══════════════════════════════════════════════════════════════

2026-01-11 22:44 - 添加 _sanitize_json_keys() 方法定义
2026-01-11 23:03 - 在 3 个位置添加调用
2026-01-11 23:12 - 添加详细调试日志
2026-01-11 23:15 - 等待你重启后端

═══════════════════════════════════════════════════════════════

重启后，KeyError: '"type"' 应该彻底解决！
如果还有任何问题，请提供 /tmp/voxchina_backend_new.log 的内容。
