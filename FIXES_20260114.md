# VoxChina 问题修复总结
**日期**: 2026-01-14  
**修复内容**: 音频生成失败 + 历史记录不显示

---

## 🎯 修复的问题

### 问题1: 音频生成失败 (500错误) ✅
**错误信息**: `Generation failed: 500 - {"detail":"Audio generation failed"}`

**根本原因**:
- TTS服务错误处理不完善，无法准确定位失败原因
- 日志信息不够详细，难以调试
- 错误信息未正确传递给前端

**解决方案**:
1. **改进 TTS 服务日志** (`backend/app/services/tts_service.py`)
   - 添加详细的阶段性日志（使用emoji标记）
   - 改进异常捕获和错误信息输出
   - 在模型加载、音频生成、声音转换等关键步骤添加try-catch

2. **改进 API 端点错误处理** (`backend/app/api/v1/endpoints/voices.py`)
   - 提供更具体的错误信息（CUDA、模型、内存等）
   - 区分不同类型的错误并给出相应提示
   - 添加详细的日志记录

**修改文件**:
- `backend/app/services/tts_service.py`
- `backend/app/api/v1/endpoints/voices.py`

---

### 问题2: Extraction History 显示 "No history available" ✅
**现象**: 提取文章成功后，历史记录列表仍然为空

**根本原因**:
- 提取成功后会弹出对话框询问用户是否保存到知识库
- 如果用户没有点击"保存"按钮或关闭了对话框，数据不会保存
- 历史记录从知识库获取，因此显示为空

**解决方案**:
1. **自动保存到知识库** (`frontend/src/views/MainPage.vue`)
   - 提取成功后自动静默保存到知识库
   - 不再弹出询问对话框
   - 保存后自动刷新历史记录列表

2. **在页面加载时获取历史记录**
   - 在 `onMounted` 中调用 `fetchAcademicHistory()`
   - 确保页面打开时就能看到历史记录

**修改文件**:
- `frontend/src/views/MainPage.vue`

**关键代码改动**:
```javascript
// 提取成功后自动保存
setTimeout(async () => {
  academicExtracting.value = false;
  
  // Automatically save to knowledge base (silent save)
  console.log('[Academic Extract] Auto-saving to knowledge base...');
  try {
    await autoSaveToKB(result);
  } catch (e) {
    console.error('[Academic Extract] Auto-save failed, but continuing:', e);
  }
}, 500);

// 自动保存函数
const autoSaveToKB = async (result: any) => {
  try {
    // 保存到知识库
    const response = await fetchWithAuth(`${API_BASE_URL}/api/v1/academic-extract/save-to-kb`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        summary_zh: result.summary_zh || '',
        summary_en: result.summary_en || '',
        fact_table: result.fact_table || {}
      })
    });
    
    if (response.ok) {
      // 静默刷新历史记录
      await fetchAcademicHistory();
    }
  } catch (e) {
    // 静默失败，不中断用户体验
    console.error('[Auto KB Save] Error:', e);
  }
};
```

---

## 🚀 部署步骤

### 1. 前端（自动生效）
前端使用 Vite 热重载，修改会自动生效。如果没有自动生效，请刷新浏览器页面。

### 2. 后端（需要重启）
后端修改需要重启服务才能生效。请使用以下命令：

```bash
cd /www/wwwroot/voxchina/backend
sudo bash restart_as_www.sh
```

或者：

```bash
# 找到当前运行的进程
ps aux | grep "uvicorn.*8300" | grep -v grep

# 杀掉进程（需要www用户权限或sudo）
sudo kill -9 <PID>

# 重新启动
cd /www/wwwroot/voxchina/backend
sudo -u www bash -c "source venv/bin/activate && nohup python -m uvicorn main:app --host 0.0.0.0 --port 8300 --workers 1 > /dev/null 2>&1 &"
```

---

## ✅ 验证步骤

### 验证问题1（音频生成）:
1. 打开前端页面
2. 进入 Academic Extract 标签页
3. 上传一篇论文并提取
4. 提取成功后，选择一个声音，点击"Generate Voice Broadcast"
5. 观察：
   - 如果成功：应该生成音频并可以播放
   - 如果失败：查看后端日志 `/www/wwwroot/voxchina/backend/logs/voxchina_<date>.log`
   - 新的日志会显示详细的错误信息（带emoji标记）

### 验证问题2（历史记录）:
1. 打开前端页面
2. 进入 Academic Extract 标签页
3. 上传一篇论文并点击"Start Extraction"
4. 等待提取完成（不要关闭浏览器）
5. 滚动到"Extraction History"部分
6. 应该能看到刚才提取的文章出现在历史记录中

---

## 📊 预期效果

### 音频生成改进:
- ✅ 更详细的错误日志（带emoji标记，便于快速定位）
- ✅ 前端收到更具体的错误提示
- ✅ 便于调试和排查问题

### 历史记录改进:
- ✅ 提取成功后自动保存到知识库
- ✅ 历史记录自动刷新
- ✅ 用户无需手动点击保存按钮

---

## 📝 注意事项

1. **音频生成的常见问题**：
   - 如果仍然失败，检查：
     - MeloTTS/OpenVoice 模型是否正确安装
     - CUDA/GPU 是否可用（如果使用GPU）
     - 磁盘空间是否充足
     - 后端日志中的详细错误信息

2. **历史记录的依赖**：
   - 历史记录依赖 Qdrant 知识库
   - 如果知识库服务不可用，历史记录无法保存
   - Ollama 嵌入服务必须正常运行（qwen3-embedding模型）

3. **浏览器缓存**：
   - 如果前端修改未生效，尝试硬刷新（Ctrl+Shift+R 或 Cmd+Shift+R）

---

## 🔗 相关文件

### 后端:
- `backend/app/services/tts_service.py` - TTS服务核心逻辑
- `backend/app/api/v1/endpoints/voices.py` - 音频预览API
- `backend/app/api/v1/endpoints/academic_extract.py` - 学术提取API

### 前端:
- `frontend/src/views/MainPage.vue` - 主页面组件

---

**修复完成时间**: 2026-01-14 18:52
**修复人**: AI Assistant
**作者**: Ren CBIT https://github.com/reneverland/
